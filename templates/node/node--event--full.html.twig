{{ drupal_entity('block', 'yalesitesbreadcrumbs', check_access=false) }}

{#
  Please make this backend.  ;)
  Is it worth me making this a hook?
#}
{#
  The duration that is set when you select "all day"

  This is done because smart date is not exposing to node whether you selected
  all day or not
#}
{% set all_day_duration = 1439 %}

{#
  Since each all day day adds an extra minute, we create a delta based on the
  number of days selected
#}
{% set delta = (node.field_event_date.duration // all_day_duration) %}

{% set format_labels = [] %}
{% for item in node.field_event_type %}
  {% set format_labels = format_labels|merge([ item.entity.label ]) %}
{% endfor %}

{% if node.field_event_date.getValue() %}
  {# Convert integers to datetime objects for use in calendar link #}
  {% set start_datetime = date(node.field_event_date.value|date_modify('+0 hour')) %}
  {% set end_datetime = date(node.field_event_date.end_value|date_modify('+0 hour')) %}

  {% set component_date_start = node.field_event_date.value %}
  {% set component_date_end = node.field_event_date.end_value %}

  {% set event_meta__all_day = (node.field_event_date.duration % all_day_duration) <= delta %}

  {#
    The component is specifying the location as hybrid if multiple formats are
    selected, so I decided to try to follow suit
  #}
  {% set isHybrid = format_labels|length > 1 %}
  {% set calendar_location_text = isHybrid ? 'Hybrid' : format_labels|first %}

  {% set cal_link = calendar_link('ics', node.title, start_datetime, end_datetime, event_meta__all_day, 'description', calendar_location_text) %}
  {% set cal_text = 'Add to Calendar' %}
{% endif %}

{% include "@molecules/meta/event-meta/yds-event-meta.twig" with {
  event_title__heading: label,
  event_meta__date_start: component_date_start,
  event_meta__date_end: component_date_end,
  event_meta__format: format_labels,
  event_meta__address: nothing_yet,
  event_meta__cta_primary__content: node.field_event_cta.title,
  event_meta__cta_primary__href: node.field_event_cta.0.getUrl().toString(),
  event_meta__cta_secondary__content: cal_text,
  event_meta__cta_secondary__href: cal_link,
} %}

{{ content|without('field_event_date', 'field_event_format', 'field_event_cta') }}
